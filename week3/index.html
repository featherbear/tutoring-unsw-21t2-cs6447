<!doctype html><html lang=en><head><meta charset=utf-8><title>Week 3</title><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel=stylesheet href=../reveal-js/css/reset.css><link rel=stylesheet href=../reveal-js/css/reveal.css><link rel=stylesheet href=../reveal-js/css/theme/black.css id=theme><link rel=stylesheet href=../highlight-js/default.min.css></head><body><div class=reveal><div class=slides><section data-noprocess data-shortcode-slide class=center><h2 id=week-3>Week 3</h2></section><section data-noprocess data-shortcode-slide><h2 id=good-faith-policy>Good Faith Policy</h2><blockquote><p>&ldquo;These courses expects a high standard of professionalism from its students with regard to how security testing is conducted. We expect all students to act in good faith at all times [&mldr;]&rdquo;</p></blockquote><p>TL;DR Don&rsquo;t be mean</p><p><a href=https://sec.edu.au/good-faith-policy>https://sec.edu.au/good-faith-policy</a></p></section><section data-noprocess data-shortcode-slide class=center><h2 id=cdecl-again>cdecl, again</h2><pre><code class=language-c>mycoolfunc(arg1, arg2, arg3);
                               | 0xFF
push arg3                      |      arg3
push arg2                      |      arg2
push arg1                      |      arg1
call mycoolfunc                |      ret_addr  &lt;-- esp
                               | 0x00
</code></pre></section><section><h2 id=format-strings>Format Strings</h2><section data-shortcode-section><blockquote><p>Used in C library functions</p></blockquote><ul><li><code>[s,sn,v,va,...]printf</code></li><li><code>[s,sn,v,va,...]scanf</code></li><li>etc</li></ul></section><section><blockquote><p><code>printf(format, ...vargs)</code></p></blockquote><p>¬†</p><p><code>printf("%s world!", "hello");</code></p><p>¬†</p><p><code>printf("üëã üåè!");</code></p></section></section><section><h2 id=format-specifier>Format Specifier</h2><section data-shortcode-section><p><span style=font-size:.75em><code>%&lt;flags>&lt;width>&lt;precision>&lt;modifier></code><u><b><code>&lt;type></code></b></u></span></p><ul><li><code>%s</code> - print as string</li><li><code>%x</code> - print as hex</li><li><code>%p</code> - print as pointer</li><li><code>%c</code> - print as char</li><li><code>%d</code> - print as (signed) int</li><li><code>%u</code> - print as (unsigned) int</li><li><code>%n</code> - <u>write</u> the number of printed bytes&mldr;</li></ul></section><section><p><span style=font-size:.75em><code>%&lt;flags>&lt;width>&lt;precision></code><u><b><code>&lt;modifier></code></b></u><code>&lt;type></code></span></p><ul><li><p><code>%d</code> - print as (signed) int</p></li><li><p><code>%hd</code> - print as half (signed) int</p></li><li><p><code>%hhd</code> - print as half half (signed) int</p></li><li><p><code>%n</code> - write as int</p></li><li><p><code>%hn</code> - write as half int</p></li><li><p><code>%hhn</code> - write as half half int</p></li></ul></section><section><p><span style=font-size:.75em><code>%&lt;flags>&lt;width></code><u><b><code>&lt;precision></code></b></u><code>&lt;modifier>&lt;type></code></span></p><p>¬†<br>Output <strong>maximum</strong> limit
¬†</p><pre><code class=language-c>printf(&quot;%.3s&quot;, &quot;abcdef&quot;);

$&gt; &quot;abc&quot;
</code></pre><pre><code class=language-c>printf(&quot;%.5f&quot;, 4 * 1.0 / 3);

$&gt; 1.33333
</code></pre></section><section><p><span style=font-size:.75em><code>%&lt;flags></code><u><b><code>&lt;width></code></b></u><code>&lt;precision>&lt;modifier>&lt;type></code></span></p><p>¬†<br>Output <strong>minimum</strong> limit
¬†</p><pre><code class=language-c>printf(&quot;%d&quot;, 10);

$&gt; 10
</code></pre><pre><code class=language-c>printf(&quot;%5d&quot;, 10);

$&gt;    10
</code></pre><pre><code class=language-c>printf(&quot;%10d&quot;, 10);

$&gt;         10
</code></pre></section><section><p><span style=font-size:.75em><code>%</code><u><b><code>&lt;flags></code></b></u><code>&lt;width>&lt;precision>&lt;modifier>&lt;type></code></span></p><p>¬†<br>Modifiers, eh.
¬†</p><ul><li><code>-</code> - Left-align the output</li><li><code>+</code> - Prepends a plus for +ve signed-numeric types</li><li><code></code>- Prepends a space for +ve signed-numeric types</li><li><code>0</code> - Prepends zeros</li><li><code>'</code> - Show thousandths separators</li><li><code>#</code> - misc.</li></ul></section><section data-noprocess data-shortcode-slide class=center><p>jks one more</p></section><section><p><span style=font-size:.75em><code>%</code><u><b><code>&lt;parameter></code></b></u></span><span style=font-size:.5em><code>&lt;flags>&lt;width>&lt;precision>&lt;modifier>&lt;type></code></span></p><p>¬†<br>Allows you to specify a certain index from the vargs.<br>¬†</p><blockquote><p><code>%&lt;idx>$...</code></p></blockquote><pre><code class=language-c>printf(&quot;%3$c %1$s %2$d&quot;, &quot;string&quot;, 50, 'c')

$&gt; c string 50
</code></pre></section></section><section><h3 id=format-string-vulnerabilities>Format String Vulnerabilities</h3><p>What if you don&rsquo;t provide any arguments?</p><pre><code class=language-c>printf(&quot;%d %d %d %d %s)
</code></pre><ul><li>Responsibility of the caller to push the relevant data</li><li>Program will just grab items off the stack</li></ul></section><section><h4 id=read-primitive>Read Primitive</h4><section data-shortcode-section><p>For numbers&mldr;</p><ul><li><code>%d</code> will read the next item on the stack</li><li><code>%20$d</code> will read the 20th item from the stack</li></ul><p>For hex&mldr;</p><ul><li><code>%p</code> will read the next item on the stack</li><li><code>%20$p</code> will read the 20th item from the stack</li></ul><p>For addresses&mldr;</p><ul><li><code>%s</code> will read the next item (as a pointer) on the stack</li><li><code>%20$s</code> will read the 20th item (pointer) on the stack</li></ul></section><section data-noprocess data-shortcode-slide class=center><blockquote><p>Demo: <code>./leakValues</code></p></blockquote></section><section><p>Your C code may not reflect the correct order of function locals <em>(bc compiler optimisations)</em></p><blockquote><p>Demo: <code>./varOrder</code></p></blockquote></section></section><section><h4 id=write-primitive>Write Primitive</h4><section data-shortcode-section><blockquote><p><code>%n</code> format specifier</p></blockquote><p>Writes the number of printed bytes to the next item (pointer) on the stack</p><p>¬†</p><blockquote><p><code>%7$n</code> format specifier</p></blockquote><p>Writes the number of printed bytes to the seventh item (pointer) on the stack</p></section><section><h5 id=alignment>Alignment</h5><p>Sometimes our values aren&rsquo;t aligned to the 4-byte boundary. We just need to pad our values then :)</p><blockquote><p>Demo: <code>./printfRunner</code></p></blockquote></section><section data-noprocess data-shortcode-slide class=center><blockquote><p>Demo: <code>./setValue</code></p></blockquote></section></section><section><h2 id=tldr>TL;Dr</h2><section data-shortcode-section><ul><li>If our address is on the stack, we can read and write from that address</li><li>If our format specifier buffer is on the stack, we can read and write from addresses in the buffer</li></ul><blockquote><p><em>i.e. write <code>0xdeadbeef</code> into our buffer, then write into that address</em></p></blockquote></section><section><ul><li>Find our buffer region (relative the format string)</li><li>Pad the payload (if needed)</li><li>Write the 4-byte address(es)</li><li>Write bytes (<code>...</code> or <code>%...$c</code>)</li><li>Write into the address (<code>%...$n / hn / hhn</code>)</li></ul></section></section><section><h2 id=write-optimisation>Write Optimisation</h2><ul><li>Write one 4-byte value (max = 2^32 = 4,294,967,296)</li><li>Write two 2-byte values (max = 2 x 2^16 = 131,072)</li><li>Or&mldr; write four 1-byte values (max = 4 x 2^8 = 1024)</li></ul><p>Craft your write payload wisely!<br>Sometimes you don&rsquo;t have alot of buffer space</p><blockquote><p>Demo: <code>./setValueBig</code> - better-ish</p></blockquote><blockquote><p>Demo: <code>./setValueBig</code> - better</p></blockquote></section><section><h2 id=where-write>Where Write?</h2><section data-shortcode-section><ul><li>Variables</li><li>PLT / GOT (dynamic library function calls)</li><li>Function hooks (malloc hook, free hook, __atexit)</li></ul></section><section><h4 id=got>GOT</h4><p>GOT - Global Offset Table<br>PLT - Process Linkage Table</p><ul><li>Calls to library functions go through a redirection.</li><li>Entries in the GOT are unset until first called<ul><li>They initially point to some lookup handler<ul><li>The lookup handler replaces the uninitialised value with the correct address</li></ul></li></ul></li></ul></section><section><ul><li><code>got</code> command - shows all of the linkable functions</li><li><code>vmmap</code> command - shows all the memory regions<ul><li>useful for figuring out offsets later on</li></ul></li></ul></section></section><section><h3 id=memory-protection>Memory Protection</h3><section data-shortcode-section><ul><li>Memory Corruption<ul><li>stack reordering</li><li>random padding</li><li>stack canaries</li><li>FORTIFY</li><li>RELRO</li></ul></li></ul></section><section><ul><li>Post-corruption code execution<ul><li>ASLR + PIE</li><li>NX</li><li>PAC</li><li>Hypervisor</li></ul></li></ul></section><section><ul><li><p>PIE - Program can only contain relative jumps</p><ul><li>Requires ASLR to be on</li></ul></li><li><p>FORTIFY - Stop string vulnerabilities</p><ul><li>Disables <code>%n</code> if the fmtstr is in writeable memory</li></ul></li><li><p>RELRO - Relocation Read-Only</p><ul><li>GOT is read-only</li><li>Partial - GOT appears before BSS (globals)</li><li>Full RELRO - rip.</li></ul></li></ul></section></section><section><h2 id=general-pointer-addresses>General Pointer Addresses</h2><ul><li><code>0x565</code> - Binary base with PIE enabled</li><li><code>0x804</code> - Binary base with PIE disabled</li><li><code>0xf7f</code> - Library base</li><li><code>0xff..</code> - Stack base</li></ul></section><section data-noprocess data-shortcode-slide class=center><h1 id=activities>Activities</h1><blockquote><p>Lab 3: <code>./format_prac</code></p></blockquote><p>also, wargames 2 are due tonight at 5.59pm!</p></section></div></div><script type=text/javascript src=../reveal-hugo/object-assign.js></script><a href=../reveal-js/css/print/ id=print-location style=display:none></a><script type=text/javascript>var printLocationElement=document.getElementById('print-location');var link=document.createElement('link');link.rel='stylesheet';link.type='text/css';link.href=printLocationElement.href+(window.location.search.match(/print-pdf/gi)?'pdf.css':'paper.css');document.getElementsByTagName('head')[0].appendChild(link);</script><script type=application/json id=reveal-hugo-site-params>{"center":false,"history":true,"pdf_separate_fragments":false,"slide_number":true}</script><script type=application/json id=reveal-hugo-page-params>null</script><script src=../reveal-js/js/reveal.js></script><script type=text/javascript>function camelize(map){if(map){Object.keys(map).forEach(function(k){newK=k.replace(/(\_\w)/g,function(m){return m[1].toUpperCase()});if(newK!=k){map[newK]=map[k];delete map[k];}});}
return map;}
var revealHugoDefaults={center:true,controls:true,history:true,progress:true,transition:"slide"};var revealHugoSiteParams=JSON.parse(document.getElementById('reveal-hugo-site-params').innerHTML);var revealHugoPageParams=JSON.parse(document.getElementById('reveal-hugo-page-params').innerHTML);var options=Object.assign({},camelize(revealHugoDefaults),camelize(revealHugoSiteParams),camelize(revealHugoPageParams));Reveal.initialize(options);</script><script type=text/javascript src=../reveal-js/plugin/markdown/marked.js></script><script type=text/javascript src=../reveal-js/plugin/markdown/markdown.js></script><script type=text/javascript src=../reveal-js/plugin/highlight/highlight.js></script><script type=text/javascript src=../reveal-js/plugin/zoom-js/zoom.js></script><script type=text/javascript src=../reveal-js/plugin/notes/notes.js></script><script type=text/javascript>document.title+=" | COMP6447 Tutorial Slides";window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]},svg:{fontCache:'global'}};</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script><script>if(window.location.search.match(/\?print-pdf/gi)){function insertCSS(src){const link=document.createElement('link');link.rel='stylesheet';link.type='text/css';link.href=src;document.getElementsByTagName('head')[0].appendChild(link);}
insertCSS('\/reveal-js\/css\/print\/pdf.css');insertCSS('\/hideHomeButton.css');}</script><script>(function(f,a,t,h,o,m){a[h]=a[h]||function(){(a[h].q=a[h].q||[]).push(arguments)};o=f.createElement('script'),m=f.getElementsByTagName('script')[0];o.async=1;o.src=t;o.id='fathom-script';m.parentNode.insertBefore(o,m)})(document,window,'//ss.featherbear.cc/tracker.js','fathom');fathom('set','siteId','VQPYQ');fathom('trackPageview');</script><a id=homeButton style=position:fixed;bottom:8px;left:8px;z-index:31;font-family:Helvetica,sans-serif;font-size:12px;line-height:1;color:#fff;background-color:rgba(0,0,0,.4);padding:5px;text-decoration:none href=../>Home</a></body></html>