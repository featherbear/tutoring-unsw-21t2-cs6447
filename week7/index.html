<!doctype html><html lang=en><head><meta charset=utf-8><title>Week 7 - Heap Exploitation</title><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel=stylesheet href=../reveal-js/css/reset.css><link rel=stylesheet href=../reveal-js/css/reveal.css><link rel=stylesheet href=../reveal-js/css/theme/black.css id=theme><link rel=stylesheet href=../highlight-js/default.min.css></head><body><div class=reveal><div class=slides><section data-noprocess data-shortcode-slide class=center><h2 id=week-7>Week 7</h2><p>Heap Exploitation</p></section><section data-noprocess data-shortcode-slide><h2 id=good-faith-policy>Good Faith Policy</h2><blockquote><p>&ldquo;These courses expects a high standard of professionalism from its students with regard to how security testing is conducted. We expect all students to act in good faith at all times [&mldr;]&rdquo;</p></blockquote><p>TL;DR Don&rsquo;t be mean</p><p><a href=https://sec.edu.au/good-faith-policy>https://sec.edu.au/good-faith-policy</a></p></section><section><h5 id=a-summary-of-comp6447>A summary of COMP6447</h5><section data-shortcode-section><ul><li>Buffer Overflows</li><li>Shellcode</li><li>Format Strings</li><li>Return Oriented Programming</li><li>Today: Heap Exploitation</li></ul></section><section><h4 id=buffer-overflows>Buffer Overflows</h4><ul><li>Vulnerable memory write functions that<ul><li>Allow arbitrary input lengths</li><li>Allow longer than allocated lengths</li></ul></li><li>Allows control of variables, stack frame, etc&mldr;</li><li>Not always <code>gets</code> / <code>fgets</code><ul><li><code>strcpy</code></li></ul></li><li>Mitigation: Stack canaries<ul><li>Defeat: Leak the stack canary</li><li>Guess it</li></ul></li></ul></section><section><h4 id=shellcode>Shellcode</h4><ul><li>Program is tricked into running arbitrary instructions supplied by the user</li><li>Pop a shell?</li><li>Mitigation<ul><li>NX bit<ul><li>Defeat: ROP</li><li>Disable NX</li></ul></li><li>Small buffer
* Defeat: Egg Hunters</li></ul></li></ul></section><section><h4 id=format-strings>Format Strings</h4><ul><li><code>[..]printf</code> execution on user-controlled input</li><li>Allows arbitrary memory read</li><li>Allows arbitrary memory write</li><li>Mitigation: Be a better programmer‚Ñ¢<ul><li>Defeat: Find bad programmers /s</li></ul></li></ul></section><section><h4 id=return-oriented-programming>Return Oriented Programming</h4><ul><li>Exploits the multi-byte nature of instructions, where parts of instructions can be identified as their own instruction</li><li>Bypasses the NX bit, as the instruction address are part of the program&rsquo;s <code>text</code> region (executable)</li><li>Mitigation: Quite hard. PAC?<ul><li>Be a better programmer‚Ñ¢ x2</li></ul></li></ul></section><section><h4 id=general-protections>General Protections</h4><ul><li>ASLR - System-level address randomisation</li><li>PIE - Application-level address randomisation</li><li>RELRO - Prevents modification of the GOT</li><li>NX - Prevents execution in heap / stack</li></ul><p>Leak!</p></section><section><h4 id=attacking-the-got>Attacking the GOT</h4><ul><li>If <span data-rgb=g>no RELRO</span> - trivial</li><li>If <span data-rgb=y>partial RELRO</span> - overwrite an uninitialised entry</li><li>If <span data-rgb=r>full RELRO</span> - &mldr; overwrite a hook?</li></ul><link rel=stylesheet type=text/css href=moreRGB.css><script>{for(let elem of document.querySelectorAll('[data-rgb]')){let type=elem.dataset['rgb'].toUpperCase()
elem.innerHTML=elem.innerText.trim().split("").map(s=>`<span>${s}</span>`).join("")
elem.classList.add(`anim-text-flow${type}`)}}</script></section><section><h4 id=uncertain-memory>Uncertain Memory</h4><ul><li>NOP-sled</li><li>RET-sled</li><li>Egg Hunters<ul><li>ROP Hunters</li></ul></li></ul></section></section><section><h2 id=heap>Heap</h2><h5 id=chunks>Chunks</h5><p>A chunk can be in two states <strong>free</strong>, or <strong>in-use</strong></p><p><img width=600 src=Snipaste_2021-07-11_21-23-47.png alt=chonk></p></section><section><h5 id=header-structure>Header Structure</h5><section data-shortcode-section><h4 id=chunk--in-use>Chunk :: In Use</h4><ul><li><s>Previous Size</s></li><li>Size</li><li>AMP*</li><li><strong>Payload</strong></li></ul><p>Note: <code>malloc</code> returns the address of the payload</p><div style=text-align:left><p><span style=font-size:.8em;margin-left:100px;text-decoration:underline>*AMP</span></p><div style=font-size:.8em><ul><li><strong>A</strong>llocated Arena</li><li><strong>M</strong>emory Mapped</li><li><strong>P</strong>revious is Use</li></ul></div><div></section><section><h5 id=header-structure>Header Structure</h5><h4 id=chunk--free>Chunk :: Free</h4><ul><li>Previous Size</li><li>Size</li><li>AMP</li><li>fwd</li><li>back</li><li><span style=font-size:.6em>fd_nextsize</span></li><li><span style=font-size:.5em>fd_previoussize</span></li><li><span style=font-size:.4em>previoussize</span></li><li><span style=font-size:.3em>blah blah blah&mldr;</span></li></ul></section><section><p><img src=Snipaste_2021-07-12_18-26-16.png alt></p><ul><li>Chunks are at LEAST <code>4 * sizeof(void*)</code></li><li>Hmm mixing data and control ü§î</li></ul></section></section><section><h3 id=freechunk>free(chunk)</h3><section data-shortcode-section><blockquote><p>Freeing chunks need to be fast!</p></blockquote><ul><li>Instead of clearing the memory, we just unlink it!</li><li>Programs use several different types of &lsquo;bins&rsquo; to efficiently store information about free&rsquo;d memory.</li></ul></section><section><p>Programs use several different types of &lsquo;bins&rsquo; to efficiently store information about free&rsquo;d memory.</p><ul><li>Fast Bins</li><li>Unsorted Bins</li><li>Small Bin</li><li>Large Bin</li><li>TCache</li></ul></section><section><h5 id=fast-bins>Fast Bins</h5><ul><li>There are 10 fastbins</li><li>Small chunks are stored in size-specific bins<ul><li>16, 24, 32, 40, 48, 56, 64, 72, 80, 88 bytes</li></ul></li><li>Each fastbin is essentially a <u>single</u> linked list</li><li>For each sized fastbin<ul><li>Freed chunks added into to the <u>start</u> of the fastbin</li><li>Chunks are not combined with adjacent chunks</li><li>The first item in a fastbin is next allocated chunk<ul><li>aka the last freed chunk of that fastbin</li></ul></li></ul></li></ul></section><section><h5 id=unsorted-bins>Unsorted Bins</h5><ul><li>For large chunks, when <code>free</code>'d, chunks are stored in a single bin of varying chunk sizes</li><li>Later sorted by malloc to be optimised</li></ul><p>¬†</p><h5 id=other-bins>Other Bins</h5><p>The normal bins are divided into 62 <strong>small bins</strong> (each bin has chunks of the same size), and two <strong>large bins</strong> (where each large bin has chunks of similar size)</p></section><section><h3 id=tcache>TCache</h3><blockquote><p>Thread-local Cache</p></blockquote><p>Faster than a global cache!</p><p>Arbitrarily sized bins that have a limit of 7 chunks (by default).<br>If 7 chunks have been free&rsquo;d, tcache won&rsquo;t be used</p><p>Note: <code>calloc</code> doesn&rsquo;t use the tcache</p></section></section><section><h4 id=use-after-free>Use After Free</h4><p>When a chunk is freed, part of its contents is used as metadata&mldr; If we tamper with its contents, we can corrupt the linked list!
This allows us to control the addresses of a future malloc chunk!</p><p><em>e.g. Modify the forward pointer&mldr;</em><br><em>malloc returns our own address!</em></p><pre><code class=language-c>                         // Bin: NULL
free(chunk)              // Bin: chunk -&gt; (HEAD = NULL)
chunk = 0x41414141       // Bin: chunk -&gt; 0x41414141 -&gt; ???
dummy = malloc(...)      // Bin: 0x41414141 -&gt; ???
pwn = malloc(...) ///////// pwn = 0x41414141
</code></pre></section><section><h4 id=double-free>Double Free</h4><section data-shortcode-section><p>Systems check that you haven&rsquo;t <code>free</code>'d a memory address twice <u><strong>in a row</strong></u>.</p><pre><code class=language-c>free(a);
free(a);

// free(): double free detected
// Aborted (core dumped)
</code></pre><p>But&mldr; it doesn&rsquo;t prevent this</p><pre><code class=language-c>free(a);
free(dummy);
free(a);

// ???
</code></pre></section><section><p>When a chunk is freed the second time&mldr;</p><pre><code class=language-c>                      // Bin: NULL
free(chunk);          // Bin: chunk -&gt; (HEAD = NULL)
free(chunk);          // Bin: chunk -&gt; (HEAD = chunk) -&gt; NULL
puts(chunk.next) /////// chunk

// $$$
</code></pre><p>or maybe</p><pre><code class=language-c>                      // Bin: NULL
free(chunk);          // Bin: chunk -&gt; (HEAD = NULL)
free(chunk);          // Bin: chunk -&gt; (HEAD = chunk) -&gt; NULL
malloc(...)     // some val
malloc(...)
malloc(...)     // the same val!???
// $$$
</code></pre></section></section><section><h4 id=pwndbg>pwndbg</h4><ul><li><code>vis_heap_chunks</code></li><li><code>heap</code></li><li><code>arena</code></li><li><code>bins</code><ul><li><code>___bins</code></li></ul></li></ul><p>¬†</p><h4 id=demo-time>Demo time!</h4><blockquote><p>Double Free<br>Use After Free</p></blockquote></section><section><blockquote><p><a href=https://heap-exploitation.dhavalkapil.com>heap-exploitation.dhavalkapil.com</a></p></blockquote></section><section><h3 id=dates>Dates</h3><ul><li>Today, Tuesday, Week 7 @ 5.59pm - Wargames 5 Due</li><li>This Sunday 18/07 @ 5.59pm - Mid-point Fuzzer Due</li></ul><p>¬†</p><h3 id=activities>Activities</h3><p>üêè (s)heap üêë</p></section></div></div><script type=text/javascript src=../reveal-hugo/object-assign.js></script><a href=../reveal-js/css/print/ id=print-location style=display:none></a><script type=text/javascript>var printLocationElement=document.getElementById('print-location');var link=document.createElement('link');link.rel='stylesheet';link.type='text/css';link.href=printLocationElement.href+(window.location.search.match(/print-pdf/gi)?'pdf.css':'paper.css');document.getElementsByTagName('head')[0].appendChild(link);</script><script type=application/json id=reveal-hugo-site-params>{"center":false,"history":true,"pdf_separate_fragments":false,"slide_number":true}</script><script type=application/json id=reveal-hugo-page-params>null</script><script src=../reveal-js/js/reveal.js></script><script type=text/javascript>function camelize(map){if(map){Object.keys(map).forEach(function(k){newK=k.replace(/(\_\w)/g,function(m){return m[1].toUpperCase()});if(newK!=k){map[newK]=map[k];delete map[k];}});}
return map;}
var revealHugoDefaults={center:true,controls:true,history:true,progress:true,transition:"slide"};var revealHugoSiteParams=JSON.parse(document.getElementById('reveal-hugo-site-params').innerHTML);var revealHugoPageParams=JSON.parse(document.getElementById('reveal-hugo-page-params').innerHTML);var options=Object.assign({},camelize(revealHugoDefaults),camelize(revealHugoSiteParams),camelize(revealHugoPageParams));Reveal.initialize(options);</script><script type=text/javascript src=../reveal-js/plugin/markdown/marked.js></script><script type=text/javascript src=../reveal-js/plugin/markdown/markdown.js></script><script type=text/javascript src=../reveal-js/plugin/highlight/highlight.js></script><script type=text/javascript src=../reveal-js/plugin/zoom-js/zoom.js></script><script type=text/javascript src=../reveal-js/plugin/notes/notes.js></script><script type=text/javascript>document.title+=" | COMP6447 Tutorial Slides";window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]},svg:{fontCache:'global'}};</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script><script>if(window.location.search.match(/\?print-pdf/gi)){function insertCSS(src){const link=document.createElement('link');link.rel='stylesheet';link.type='text/css';link.href=src;document.getElementsByTagName('head')[0].appendChild(link);}
insertCSS('\/reveal-js\/css\/print\/pdf.css');insertCSS('\/hideHomeButton.css');}</script><script>(function(f,a,t,h,o,m){a[h]=a[h]||function(){(a[h].q=a[h].q||[]).push(arguments)};o=f.createElement('script'),m=f.getElementsByTagName('script')[0];o.async=1;o.src=t;o.id='fathom-script';m.parentNode.insertBefore(o,m)})(document,window,'//ss.featherbear.cc/tracker.js','fathom');fathom('set','siteId','VQPYQ');fathom('trackPageview');</script><a id=homeButton style=position:fixed;bottom:8px;left:8px;z-index:31;font-family:Helvetica,sans-serif;font-size:12px;line-height:1;color:#fff;background-color:rgba(0,0,0,.4);padding:5px;text-decoration:none href=../>Home</a></body></html>